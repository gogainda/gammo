# Gammo - A pure-Ruby HTML5 parser

[![Build Status](https://travis-ci.org/namusyaka/gammo.svg?branch=master)](https://travis-ci.org/namusyaka/gammo)
[![GitHub issues](https://img.shields.io/github/issues/namusyaka/gammo)](https://github.com/namusyaka/gammo/issues)
[![GitHub forks](https://img.shields.io/github/forks/namusyaka/gammo?color=brightgreen)](https://github.com/namusyaka/gammo/network)
[![GitHub stars](https://img.shields.io/github/stars/namusyaka/gammo?color=brightgreen)](https://github.com/namusyaka/gammo/stargazers)
[![GitHub license](https://img.shields.io/github/license/namusyaka/gammo?color=brightgreen)](https://github.com/namusyaka/gammo/blob/master/LICENSE.txt)
[![Documentation](http://img.shields.io/:yard-docs-38c800.svg)](http://www.rubydoc.info/gems/gammo/frames)

Gammo is an implementation of the HTML5 parsing algorithm which conforms [the WHATWG specification](https://html.spec.whatwg.org/multipage/parsing.html), without any dependencies. Given an HTML string, Gammo parses it and builds DOM tree based on the tokenization and tree-construction algorithm defined in WHATWG parsing algorithm.

Gammo, its naming is inspired by [Gumbo](https://github.com/google/gumbo-parser). But Gammo is a fried tofu fritter made with vegetables.

```ruby
require 'gammo'
require 'open-uri'

parser = Gammo.new(open('https://google.com'))
parser.parse #=> #<Gammo::Node::Document>
```

## Overview

### Features

- [Tokenization](#tokenization): Gammo has a tokenizer for implementing [the tokenization algorithm](https://html.spec.whatwg.org/multipage/parsing.html#tokenization).
- [Parsing](#parsing): Gammo provides a parser which implements the parsing algorithm by the above tokenization and [the tree-construction algorithm](https://html.spec.whatwg.org/multipage/parsing.html#tree-construction).
- [Node](#node): Gammo provides the nodes which implement [WHATWG DOM specification](https://dom.spec.whatwg.org/) partially.
- [Performance](#performance): Gammo does not prioritize performance, and there are a few potential performance notes.

## Tokenizaton

`Gammo::Tokenizer` implements the tokenization algorithm in WHATWG. You can get tokens in order by calling `Gammo::Tokenizer#next_token`.

Here is a simple example for performing only the tokenizer.

```ruby
def dump_for(token)
  puts "data: #{token.data}, class: #{token.class}"
end

tokenizer = Gammo::Tokenizer.new('<!doctype html><input type="button"><frameset>')
dump_for tokenizer.next_token #=> data: html, class: Gammo::Tokenizer::DoctypeToken
dump_for tokenizer.next_token #=> data: input, class: Gammo::Tokenizer::StartTagToken
dump_for tokenizer.next_token #=> data: frameset, class: Gammo::Tokenizer::StartTagToken
dump_for tokenizer.next_token #=> data: end of string, class: Gammo::Tokenizer::ErrorToken
```

The parser described below depends on this tokenizer, it applies the WHATWG parsing algorithm to the tokens extracted by this tokenization in order.

### Token types

The tokens generated by the tokenizer will be categorized into one of the following types:

<table>
  <thead>
    <tr>
      <th>Token type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Gammo::Tokenizer::ErrorToken</code></td>
      <td>Represents an error token, it usually means end-of-string.</td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::TextToken</code></td>
      <td>Represents a text token like "foo" which is inner text of elements.</td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::StartTagToken</code></td>
      <td>Represents a start tag token like <code>&lt;a&gt;</code>.</td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::EndTagToken</code></td>
      <td>Represents an end tag token like <code>&lt;/a&gt;</code>.</td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::SelfClosingTagToken</code></td>
      <td>Represents a self closing tag token like <code>&lt;img /&gt;</code></td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::CommentToken</code></td>
      <td>Represents a comment token like <code>&lt;!-- comment --&gt;</code>.</td>
    </tr>
    <tr>
      <td><code>Gammo::Tokenizer::DoctypeToken</code></td>
      <td>Represents a doctype token like <code>&lt;!doctype html&gt;</code>.</td>
    </tr>
  </tbody>
</table>

## Parsing

`Gammo::Parser` implements processing in [the tree-construction stage](https://html.spec.whatwg.org/multipage/parsing.html#tree-construction) based on the tokenization described above.

A successfully parsed parser has the `document` accessor as the root document (this is the same as the return value of the `Gammo::Parser#parse`). From the `document` accessor, you can traverse the DOM tree constructed by the parser.

```ruby
require 'gammo'
require 'pp'

document = Gammo.new('<!doctype html><input type="button">').parse

def dump_for(node, strm)
  strm << node.to_h
  return unless node && (child = node.first_child)
  while child
    dump_for(child, (strm.last[:children] ||= []))
    child = child.next_sibling
  end
  strm
end

pp dump_for(document, [])
```

### Notes

Currently, it's not possible to traverse the DOM tree with css selector or xpath like [Nokogiri](https://nokogiri.org/).
However, Gammo plans to implement these features in the future.

## Node

The nodes generated by the parser will be categorized into one of the following types:

<table>
  <thead>
    <tr>
      <th>Node type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Gammo::Node::Error</code></td>
      <td>Represents error node, it usually means end-of-string.</td>
    </tr>
    <tr>
      <td><code>Gammo::Node::Text</code></td>
      <td>Represents the text node like "foo" which is inner text of elements.</td>
    </tr>
    <tr>
      <td><code>Gammo::Node::Document</code></td>
      <td>Represents the root document type. It's always returned by <code>Gammo::Parser#document</code>.</td>
    </tr>
    <tr>
      <td><code>Gammo::Node::Element</code></td>
      <td>Represents any elements of HTML like <code>&lt;p&gt;</code>.</td>
    </tr>
    <tr>
      <td><code>Gammo::Node::Comment</code></td>
      <td>Represents comments like <code>&lt;!-- foo --&gt;</code></td>
    </tr>
    <tr>
      <td><code>Gammo::Node::Doctype</code></td>
      <td>Represents doctype like <code>&lt;!doctype html&gt;</code></td>
    </tr>
  </tbody>
</table>

For some nodes such as `Gammo::Node::Element` and `Gammo::Node::Document`, they contains pointers to nodes that can be referenced by itself, such as `Gammo::Node#next_sibling` or `Gammo::Node#first_child`. In addition, APIs such as `Gammo::Node#append_child` and `Gammo::Node#remove_child` that perform operations defined in DOM living standard are also provided.

## Performance

As mentioned in the features at the beginning, Gammo doesn't prioritize its performance.
Thus, for example, Gammo is not suitable for very performance-sensitive applications (e.g. performing Gammo parsing synchronously from an incoming request from an end user).
Instead, the goal is to work well with batch processing such as crawlers.
Gammo places the highest priority on making it easy to parse HTML by peforming it without depending on native-extensions and external gems.

## References

This was developed with reference to the following softwares.

- [x/net/html](https://godoc.org/golang.org/x/net/html): I've been working on this package, it gave me strong reason to make this happen.
- [Blink](https://www.chromium.org/blink): Blink gave me great impression about tree construction.
- [html5lib-tests](https://github.com/html5lib/html5lib-tests): Gammo relies on this test.

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
